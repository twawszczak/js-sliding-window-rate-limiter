local a=KEYS[1]local b=tonumber(ARGV[1])local c=tonumber(ARGV[2])local d=ARGV[3]~='0'redis.replicate_commands()local e=redis.call("TIME")local f=e[1]*1e6+e[2]local g=f-b*1e6;redis.call("ZREMRANGEBYSCORE",a,"-inf",g)local h=tonumber(redis.call("ZCOUNT",a,1,f))if d then if h>=c then return-h end;redis.call("ZADD",a,f,f)redis.call("EXPIRE",a,b)h=tonumber(redis.call("ZCOUNT",a,0,f))end;if h>c then return-h end;return h
