local a=KEYS[1]local b=tonumber(ARGV[1])local c=tonumber(ARGV[2])local d=tonumber(ARGV[3])local e=ARGV[4]~='0'redis.replicate_commands()local f=redis.call("TIME")local g=f[1]*1e6+f[2]local h=g-b*1e6;redis.call("ZREMRANGEBYSCORE",a,"-inf",h)local i=tonumber(redis.call("ZCOUNT",a,1,g))if e then if i>=c then return-i end;redis.call("ZADD",a,g,g)redis.call("EXPIRE",a,d)i=tonumber(redis.call("ZCOUNT",a,0,g))end;if i>c then return-i end;return i
