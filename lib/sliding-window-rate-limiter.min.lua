local a=KEYS[1]local b=tonumber(ARGV[1])local c=tonumber(ARGV[2])local d=tonumber(ARGV[3])local e=tonumber(ARGV[4])redis.replicate_commands()local f=redis.call("TIME")local g=f[1]*1e6+f[2]local h=g-c*1e6;redis.call("ZREMRANGEBYSCORE",a,"-inf",h)local i=tonumber(redis.call("ZCOUNT",a,1,g))if b==2 then redis.call("ZREM",a,e)i=tonumber(redis.call("ZCOUNT",a,0,g))elseif b==1 then if i>=d then return-i end;redis.call("ZADD",a,g,g)redis.call("EXPIRE",a,c)return g end;if i>d then return-i end;return i
